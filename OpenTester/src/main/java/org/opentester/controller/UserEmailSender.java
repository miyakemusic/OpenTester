package org.opentester.controller;

import java.net.InetAddress;
import java.net.UnknownHostException;

import org.opentester.VerificationCodeManager;
import org.opentester.dto.UserDto;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.MailException;
import org.springframework.mail.MailSender;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.stereotype.Service;
import org.springframework.ui.Model;

@Service
public class UserEmailSender {
	
	@Autowired 
	VerificationCodeManager verificationCodeManager;
	
	@Autowired
	MailSender mailSender;
	
	public void sendEmail(UserDto user, Model model, String subject, String message, String resource) throws UnknownHostException {
		
		String hostName = InetAddress.getLocalHost().getHostAddress();
		String code = verificationCodeManager.generateCode(user.getUsername());
		String html = "<html><body><a href=\"http://" + hostName + ":8080/" + resource + "?code=" + code + 
				"\">" + message + "</a></body></html>";
		
		SimpleMailMessage msg = new SimpleMailMessage();
        msg.setFrom("opentestersignup@gmail.com");
        msg.setTo(user.getUsername());
        msg.setSubject(subject);    

        msg.setText(html);
        try {
            mailSender.send(msg);
            model.addAttribute("sentemail", true);
            
        } catch (MailException e) {
            e.printStackTrace();
        }
	}
}
