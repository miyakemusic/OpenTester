package org.opentester;

import javax.sql.DataSource;

import org.opentester.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.JdbcUserDetailsManager;
import org.springframework.security.provisioning.UserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;


@Configuration
@EnableWebSecurity
public class WebSecurityConfig {
	
//	@Autowired
//	private PasswordEncoder passwordEncoder;
	
//	@Autowired
//	private UserDetailsManager jdbcUserDetailsManager;

	@Autowired
	private UserRepository userRepository;;
	
    @Bean
    public AuthenticationManager authenticationManager(
                                 AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }

	@Bean
	public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
		http.authorizeHttpRequests((requests) -> {
			requests
					.requestMatchers(PathRequest.toStaticResources().atCommonLocations()).permitAll()
					.requestMatchers("/", "/error", "/home", "/signup", "/userregistration", "/users", "/resetpassword", "/doresetpassword", "/test/*")
					.permitAll()
					.requestMatchers("/admin/*", "/admin/rest/*").hasRole("ADMIN") 
					.anyRequest().authenticated();
		}
			)
//		.csrf().disable()
			.formLogin((form) -> form
				.loginPage("/login")
				.defaultSuccessUrl("/")
				.permitAll()
			)
			.logout((logout) -> logout.permitAll());

		return http.build();
	}

//    @Bean
//    public MyUserDetailsService userDetailsManager() {
//  	MyUserDetailsService myUserDetailsManager = new MyUserDetailsService();
//    	if (!myUserDetailsManager.userExists("admin")) {
//    		myUserDetailsManager.createUser(UserDto.builder().username("admin").password(passwordEncoder().encode("admin")).roles("USER", "ADMIN").build());
//    	}
//    	return myUserDetailsManager;
//    	UserDetailsManager userDetailsManager = new JdbcUserDetailsManager(dataSource);  	
//    	if (!userDetailsManager.userExists("admin")) {
//    		UserDetails user = User.builder()
//			.username("admin")
//			.password(passwordEncoder().encode("admin"))
//			.roles("USER", "ADMIN")
//    			.build();
//    		
////    		List<GrantedAuthority> authorities = Arrays.asList(new SimpleGrantedAuthority("ROLE_ADMIN"), new SimpleGrantedAuthority("ROLE_USER"));
////    		MyUser user = new MyUser("admin", "admin", authorities);
////    		user.setFirstname("Administrator");
////    		user.setLastname("XXX");
//    		userDetailsManager.createUser(user);
//    	}
//    	return userDetailsManager;
//    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
    	return new BCryptPasswordEncoder();
    }
    
    @Bean 
    public VerificationCodeManager verificationCodeManager() {
    	return new VerificationCodeManager();
    }
    
//    @Bean
//    public PasswordEncoder passwordEncoder() {
//        return new BCryptPasswordEncoder();
//    }

 //   @Bean
//    public UserDetailsManager users(DataSource dataSource) {
//    	UserDetails user = User.builder()
//    			.username("user")
//    			.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
//    			.roles("USER")
//    			.build();
//		UserDetails admin = User.builder()
//			.username("admin")
//			.password(passwordEncoder().encode("admin"))
//			.roles("USER", "ADMIN")
//    			.build();
//    	UserDetails tester = User.builder()
//		.username("tester0001")
//		.password(passwordEncoder().encode("tester0001"))
//		.roles("TESTER")
//		.build();
    	
//    	JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
 //   	return users;
 //   		users.createUser(miyakemusic);
 //   		users.createUser(tester);
//		return jdbcUserDetailsManager;
//    }
}
